## Ustreamer base Service
x-ustreamer-svc: &ustreamer-svc
  image: mkuf/ustreamer:nightly
  restart: unless-stopped
  command:
    - "--host=0.0.0.0"
    - "--port=8080"
    - "--slowdown"
    - "--device=/dev/webcam"
    - "--resolution=1280x960"
    - "--format=MJPEG"
    - "--desired-fps=30"

## Add your personal config here
services:
  klipper:
    image: klipper:latest
    build:
      context: docker/klipper
      target: run
    depends_on:
      - klipper_host_mcu
    volumes:
      - temp_dir:/tmp
      - /dev:/dev
    devices:
      - "/dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.1:1.0=/dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.1:1.0"
      - "/dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.2:1.0=/dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.2:1.0"

  klipper_host_mcu:
    image: klipper_host_mcu:latest
    container_name: host_mcu
    build:
      context: docker/klipper
      target: host_mcu
    volumes:
      - temp_dir:/tmp
      - /dev:/dev

  webcam:
    <<: *ustreamer-svc
    container_name: webcam
    devices:
      - /dev/video0:/dev/webcam
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.webcam.loadbalancer.server.port=8080"
      - "traefik.http.routers.webcam.rule=PathPrefix(`/webcam`)"
      - "traefik.http.routers.webcam.entrypoints=web"
      - "traefik.http.middlewares.webcam.stripprefix.prefixes=/webcam"
      - "traefik.http.routers.webcam.middlewares=webcam"

volumes:
  temp_dir:
